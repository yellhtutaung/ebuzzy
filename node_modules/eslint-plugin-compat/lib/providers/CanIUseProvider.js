"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getUnsupportedTargets = getUnsupportedTargets;
exports.default = void 0;

var _data = _interopRequireDefault(require("caniuse-db/fulldata-json/data-2.0.json"));

var _Versioning = require("../Versioning");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

// $FlowFixMe: Flow import error

/**
 * Take a target's id and return it's full name by using `targetNameMappings`
 * ex. {target: and_ff, version: 40} => 'Android FireFox 40'
 */
function formatTargetNames(target) {
  const name = _Versioning.STANDARD_TARGET_NAME_MAPPING[target.target] || target.target;
  return `${name} ${target.version}`;
}
/**
 * Check if a browser version is in the range format
 * ex. 10.0-10.2
 */


function versionIsRange(version) {
  return version.includes('-');
}
/**
 * Parse version from caniuse and compare with parsed version from browserslist.
 */


function areVersionsEqual(targetVersion, statsVersion) {
  return targetVersion === parseFloat(statsVersion);
}
/*
 * Check the CanIUse database to see if targets are supported
 *
 * If no record could be found, return true. Rules might not
 * be found because they could belong to another provider
 */


function isSupportedByCanIUse(node, {
  version,
  target,
  parsedVersion
}) {
  const data = _data.default.data[node.caniuseId];
  if (!data) return true;
  const {
    stats
  } = data;
  if (!(target in stats)) return true;
  const targetStats = stats[target];

  if (versionIsRange(version)) {
    return Object.keys(targetStats).some(statsVersion => versionIsRange(statsVersion) && areVersionsEqual(parsedVersion, statsVersion) ? !targetStats[statsVersion].includes('y') : true);
  } // @TODO: This assumes that all versions are included in the cainuse db. If this is incorrect,
  //        this will return false negatives. To properly do this, we have to to range comparisons.
  //        Ex. given query for 50 and only version 40 exists in db records, return true


  if (!(version in targetStats)) return true;
  if (!targetStats[version]) return true;
  return targetStats[version].includes('y');
}
/**
 * Return an array of all unsupported targets
 */


function getUnsupportedTargets(node, targets) {
  return targets.filter(target => !isSupportedByCanIUse(node, target)).map(formatTargetNames);
}

const CanIUseProvider = [// new ServiceWorker()
{
  caniuseId: 'serviceworkers',
  astNodeType: 'NewExpression',
  object: 'ServiceWorker'
}, {
  caniuseId: 'serviceworkers',
  astNodeType: 'MemberExpression',
  object: 'navigator',
  property: 'serviceWorker'
}, // document.querySelector()
{
  caniuseId: 'queryselector',
  astNodeType: 'MemberExpression',
  object: 'document',
  property: 'querySelector'
}, // IntersectionObserver
{
  caniuseId: 'intersectionobserver',
  astNodeType: 'NewExpression',
  object: 'IntersectionObserver'
}, // ResizeObserver
{
  caniuseId: 'resizeobserver',
  astNodeType: 'NewExpression',
  object: 'ResizeObserver'
}, // PaymentRequest
{
  caniuseId: 'payment-request',
  astNodeType: 'NewExpression',
  object: 'PaymentRequest'
}, // Promises
{
  caniuseId: 'promises',
  astNodeType: 'NewExpression',
  object: 'Promise'
}, {
  caniuseId: 'promises',
  astNodeType: 'MemberExpression',
  object: 'Promise',
  property: 'resolve'
}, {
  caniuseId: 'promises',
  astNodeType: 'MemberExpression',
  object: 'Promise',
  property: 'all'
}, {
  caniuseId: 'promises',
  astNodeType: 'MemberExpression',
  object: 'Promise',
  property: 'race'
}, {
  caniuseId: 'promises',
  astNodeType: 'MemberExpression',
  object: 'Promise',
  property: 'reject'
}, // fetch
{
  caniuseId: 'fetch',
  astNodeType: 'CallExpression',
  object: 'fetch'
}, // document.currentScript()
{
  caniuseId: 'document-currentscript',
  astNodeType: 'MemberExpression',
  object: 'document',
  property: 'currentScript'
}, // URL
{
  caniuseId: 'url',
  astNodeType: 'NewExpression',
  object: 'URL'
}, // URLSearchParams
{
  caniuseId: 'urlsearchparams',
  astNodeType: 'NewExpression',
  object: 'URLSearchParams'
}, // performance.now()
{
  caniuseId: 'high-resolution-time',
  astNodeType: 'MemberExpression',
  object: 'performance',
  property: 'now'
}, {
  caniuseId: 'typedarrays',
  astNodeType: 'NewExpression',
  object: 'TypedArray'
}, {
  caniuseId: 'typedarrays',
  astNodeType: 'NewExpression',
  object: 'Int8Array'
}, {
  caniuseId: 'typedarrays',
  astNodeType: 'NewExpression',
  object: 'Uint8Array'
}, {
  caniuseId: 'typedarrays',
  astNodeType: 'NewExpression',
  object: 'Uint8ClampedArray'
}, {
  caniuseId: 'typedarrays',
  astNodeType: 'NewExpression',
  object: 'Int16Array'
}, {
  caniuseId: 'typedarrays',
  astNodeType: 'NewExpression',
  object: 'Uint16Array'
}, {
  caniuseId: 'typedarrays',
  astNodeType: 'NewExpression',
  object: 'Int32Array'
}, {
  caniuseId: 'typedarrays',
  astNodeType: 'NewExpression',
  object: 'Uint32Array'
}, {
  caniuseId: 'typedarrays',
  astNodeType: 'NewExpression',
  object: 'Float32Array'
}, {
  caniuseId: 'typedarrays',
  astNodeType: 'NewExpression',
  object: 'Float64Array'
}].map(rule => ({ ...rule,
  getUnsupportedTargets,
  id: rule.property ? `${rule.object}.${rule.property}` : rule.object,
  protoChainId: rule.property ? `${rule.object}.${rule.property}` : rule.object,
  protoChain: rule.property ? [rule.object, rule.property] : [rule.object]
}));
var _default = CanIUseProvider;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9wcm92aWRlcnMvQ2FuSVVzZVByb3ZpZGVyLmpzIl0sIm5hbWVzIjpbImZvcm1hdFRhcmdldE5hbWVzIiwidGFyZ2V0IiwibmFtZSIsIlNUQU5EQVJEX1RBUkdFVF9OQU1FX01BUFBJTkciLCJ2ZXJzaW9uIiwidmVyc2lvbklzUmFuZ2UiLCJpbmNsdWRlcyIsImFyZVZlcnNpb25zRXF1YWwiLCJ0YXJnZXRWZXJzaW9uIiwic3RhdHNWZXJzaW9uIiwicGFyc2VGbG9hdCIsImlzU3VwcG9ydGVkQnlDYW5JVXNlIiwibm9kZSIsInBhcnNlZFZlcnNpb24iLCJkYXRhIiwiY2FuSVVzZVJlY29yZHMiLCJjYW5pdXNlSWQiLCJzdGF0cyIsInRhcmdldFN0YXRzIiwiT2JqZWN0Iiwia2V5cyIsInNvbWUiLCJnZXRVbnN1cHBvcnRlZFRhcmdldHMiLCJ0YXJnZXRzIiwiZmlsdGVyIiwibWFwIiwiQ2FuSVVzZVByb3ZpZGVyIiwiYXN0Tm9kZVR5cGUiLCJvYmplY3QiLCJwcm9wZXJ0eSIsInJ1bGUiLCJpZCIsInByb3RvQ2hhaW5JZCIsInByb3RvQ2hhaW4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7O0FBRUE7O0FBQ0E7Ozs7QUFGQTs7QUFlQTs7OztBQUlBLFNBQVNBLGlCQUFULENBQTJCQyxNQUEzQixFQUFtRDtBQUNqRCxRQUFNQyxJQUFJLEdBQUdDLHlDQUE2QkYsTUFBTSxDQUFDQSxNQUFwQyxLQUErQ0EsTUFBTSxDQUFDQSxNQUFuRTtBQUNBLFNBQVEsR0FBRUMsSUFBSyxJQUFHRCxNQUFNLENBQUNHLE9BQVEsRUFBakM7QUFDRDtBQUVEOzs7Ozs7QUFJQSxTQUFTQyxjQUFULENBQXdCRCxPQUF4QixFQUFrRDtBQUNoRCxTQUFPQSxPQUFPLENBQUNFLFFBQVIsQ0FBaUIsR0FBakIsQ0FBUDtBQUNEO0FBRUQ7Ozs7O0FBR0EsU0FBU0MsZ0JBQVQsQ0FDRUMsYUFERixFQUVFQyxZQUZGLEVBR1c7QUFDVCxTQUFPRCxhQUFhLEtBQUtFLFVBQVUsQ0FB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LEVBQUFBLFNBQVMsRUFBRSxhQURiO0FBRUVXLEVBQUFBLFdBQVcsRUFBRSxlQUZmO0FBR0VDLEVBQUFBLE1BQU0sRUFBRTtBQUhWLENBNUltQyxFQWlKbkM7QUFDRVosRUFBQUEsU0FBUyxFQUFFLGFBRGI7QUFFRVcsRUFBQUEsV0FBVyxFQUFFLGVBRmY7QUFHRUMsRUFBQUEsTUFBTSxFQUFFO0FBSFYsQ0FqSm1DLEVBc0puQ0gsR0F0Sm1DLENBc0ovQkssSUFBSSxLQUFLLEVBQ2IsR0FBR0EsSUFEVTtBQUViUixFQUFBQSxxQkFGYTtBQUdiUyxFQUFBQSxFQUFFLEVBQUVELElBQUksQ0FBQ0QsUUFBTCxHQUFpQixHQUFFQyxJQUFJLENBQUNGLE1BQU8sSUFBR0UsSUFBSSxDQUFDRCxRQUFTLEVBQWhELEdBQW9EQyxJQUFJLENBQUNGLE1BSGhEO0FBSWJJLEVBQUFBLFlBQVksRUFBRUYsSUFBSSxDQUFDRCxRQUFMLEdBQWlCLEdBQUVDLElBQUksQ0FBQ0YsTUFBTyxJQUFHRSxJQUFJLENBQUNELFFBQVMsRUFBaEQsR0FBb0RDLElBQUksQ0FBQ0YsTUFKMUQ7QUFLYkssRUFBQUEsVUFBVSxFQUFFSCxJQUFJLENBQUNELFFBQUwsR0FBZ0IsQ0FBQ0MsSUFBSSxDQUFDRixNQUFOLEVBQWNFLElBQUksQ0FBQ0QsUUFBbkIsQ0FBaEIsR0FBK0MsQ0FBQ0MsSUFBSSxDQUFDRixNQUFOO0FBTDlDLENBQUwsQ0F0SjJCLENBQXJDO2VBOEplRixlIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQGZsb3dcbi8vICRGbG93Rml4TWU6IEZsb3cgaW1wb3J0IGVycm9yXG5pbXBvcnQgY2FuSVVzZVJlY29yZHMgZnJvbSAnY2FuaXVzZS1kYi9mdWxsZGF0YS1qc29uL2RhdGEtMi4wLmpzb24nO1xuaW1wb3J0IHsgU1RBTkRBUkRfVEFSR0VUX05BTUVfTUFQUElORyB9IGZyb20gJy4uL1ZlcnNpb25pbmcnO1xuaW1wb3J0IHR5cGUgeyBOb2RlLCBUYXJnZXRzLCBUYXJnZXQgfSBmcm9tICcuLi9MaW50VHlwZXMnO1xuXG50eXBlIENhbklVc2VTdGF0cyA9IHtcbiAgW2Jyb3dzZXI6IHN0cmluZ106IHtcbiAgICBbdmVyc2lvbjogc3RyaW5nXTogc3RyaW5nXG4gIH1cbn07XG5cbnR5cGUgQ2FuSVVzZVJlY29yZHMgPSB7XG4gIGRhdGE6IENhbklVc2VTdGF0c1xufTtcblxuLyoqXG4gKiBUYWtlIGEgdGFyZ2V0J3MgaWQgYW5kIHJldHVybiBpdCdzIGZ1bGwgbmFtZSBieSB1c2luZyBgdGFyZ2V0TmFtZU1hcHBpbmdzYFxuICogZXguIHt0YXJnZXQ6IGFuZF9mZiwgdmVyc2lvbjogNDB9ID0+ICdBbmRyb2lkIEZpcmVGb3ggNDAnXG4gKi9cbmZ1bmN0aW9uIGZvcm1hdFRhcmdldE5hbWVzKHRhcmdldDogVGFyZ2V0KTogc3RyaW5nIHtcbiAgY29uc3QgbmFtZSA9IFNUQU5EQVJEX1RBUkdFVF9OQU1FX01BUFBJTkdbdGFyZ2V0LnRhcmdldF0gfHwgdGFyZ2V0LnRhcmdldDtcbiAgcmV0dXJuIGAke25hbWV9ICR7dGFyZ2V0LnZlcnNpb259YDtcbn1cblxuLyoqXG4gKiBDaGVjayBpZiBhIGJyb3dzZXIgdmVyc2lvbiBpcyBpbiB0aGUgcmFuZ2UgZm9ybWF0XG4gKiBleC4gMTAuMC0xMC4yXG4gKi9cbmZ1bmN0aW9uIHZlcnNpb25Jc1JhbmdlKHZlcnNpb246IHN0cmluZyk6IGJvb2xlYW4ge1xuICByZXR1cm4gdmVyc2lvbi5pbmNsdWRlcygnLScpO1xufVxuXG4vKipcbiAqIFBhcnNlIHZlcnNpb24gZnJvbSBjYW5pdXNlIGFuZCBjb21wYXJlIHdpdGggcGFyc2VkIHZlcnNpb24gZnJvbSBicm93c2Vyc2xpc3QuXG4gKi9cbmZ1bmN0aW9uIGFyZVZlcnNpb25zRXF1YWwoXG4gIHRhcmdldFZlcnNpb246IG51bWJlcixcbiAgc3RhdHNWZXJzaW9uOiBzdHJpbmdcbik6IGJvb2xlYW4ge1xuICByZXR1cm4gdGFyZ2V0VmVyc2lvbiA9PT0gcGFyc2VGbG9hdChzdGF0c1ZlcnNpb24pO1xufVxuXG4vKlxuICogQ2hlY2sgdGhlIENhbklVc2UgZGF0YWJhc2UgdG8gc2VlIGlmIHRhcmdldHMgYXJlIHN1cHBvcnRlZFxuICpcbiAqIElmIG5vIHJlY29yZCBjb3VsZCBiZSBmb3VuZCwgcmV0dXJuIHRydWUuIFJ1bGVzIG1pZ2h0IG5vdFxuICogYmUgZm91bmQgYmVjYXVzZSB0aGV5IGNvdWxkIGJlbG9uZyB0byBhbm90aGVyIHByb3ZpZGVyXG4gKi9cbmZ1bmN0aW9uIGlzU3VwcG9ydGVkQnlDYW5JVXNlKFxuICBub2RlOiBOb2RlLFxuICB7IHZlcnNpb24sIHRhcmdldCwgcGFyc2VkVmVyc2lvbiB9OiBUYXJnZXRcbik6IGJvb2xlYW4ge1xuICBjb25zdCBkYXRhID0gKGNhbklVc2VSZWNvcmRzOiBDYW5JVXNlUmVjb3JkcykuZGF0YVtub2RlLmNhbml1c2VJZF07XG5cbiAgaWYgKCFkYXRhKSByZXR1cm4gdHJ1ZTtcbiAgY29uc3QgeyBzdGF0cyB9ID0gZGF0YTtcbiAgaWYgKCEodGFyZ2V0IGluIHN0YXRzKSkgcmV0dXJuIHRydWU7XG5cbiAgY29uc3QgdGFyZ2V0U3RhdHMgPSBzdGF0c1t0YXJnZXRdO1xuXG4gIGlmICh2ZXJzaW9uSXNSYW5nZSh2ZXJzaW9uKSkge1xuICAgIHJldHVybiBPYmplY3Qua2V5cyh0YXJnZXRTdGF0cykuc29tZSgoc3RhdHNWZXJzaW9uOiBzdHJpbmcpOiBib29sZWFuID0+XG4gICAgICB2ZXJzaW9uSXNSYW5nZShzdGF0c1ZlcnNpb24pICYmXG4gICAgICBhcmVWZXJzaW9uc0VxdWFsKHBhcnNlZFZlcnNpb24sIHN0YXRzVmVyc2lvbilcbiAgICAgICAgPyAhdGFyZ2V0U3RhdHNbc3RhdHNWZXJzaW9uXS5pbmNsdWRlcygneScpXG4gICAgICAgIDogdHJ1ZVxuICAgICk7XG4gIH1cblxuICAvLyBAVE9ETzogVGhpcyBhc3N1bWVzIHRoYXQgYWxsIHZlcnNpb25zIGFyZSBpbmNsdWRlZCBpbiB0aGUgY2FpbnVzZSBkYi4gSWYgdGhpcyBpcyBpbmNvcnJlY3QsXG4gIC8vICAgICAgICB0aGlzIHdpbGwgcmV0dXJuIGZhbHNlIG5lZ2F0aXZlcy4gVG8gcHJvcGVybHkgZG8gdGhpcywgd2UgaGF2ZSB0byB0byByYW5nZSBjb21wYXJpc29ucy5cbiAgLy8gICAgICAgIEV4LiBnaXZlbiBxdWVyeSBmb3IgNTAgYW5kIG9ubHkgdmVyc2lvbiA0MCBleGlzdHMgaW4gZGIgcmVjb3JkcywgcmV0dXJuIHRydWVcbiAgaWYgKCEodmVyc2lvbiBpbiB0YXJnZXRTdGF0cykpIHJldHVybiB0cnVlO1xuICBpZiAoIXRhcmdldFN0YXRzW3ZlcnNpb25dKSByZXR1cm4gdHJ1ZTtcblxuICByZXR1cm4gdGFyZ2V0U3RhdHNbdmVyc2lvbl0uaW5jbHVkZXMoJ3knKTtcbn1cblxuLyoqXG4gKiBSZXR1cm4gYW4gYXJyYXkgb2YgYWxsIHVuc3VwcG9ydGVkIHRhcmdldHNcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGdldFVuc3VwcG9ydGVkVGFyZ2V0cyhcbiAgbm9kZTogTm9kZSxcbiAgdGFyZ2V0czogVGFyZ2V0c1xuKTogQXJyYXk8c3RyaW5nPiB7XG4gIHJldHVybiB0YXJnZXRzXG4gICAgLmZpbHRlcih0YXJnZXQgPT4gIWlzU3VwcG9ydGVkQnlDYW5JVXNlKG5vZGUsIHRhcmdldCkpXG4gICAgLm1hcChmb3JtYXRUYXJnZXROYW1lcyk7XG59XG5cbmNvbnN0IENhbklVc2VQcm92aWRlcjogQXJyYXk8Tm9kZT4gPSBbXG4gIC8vIG5ldyBTZXJ2aWNlV29ya2VyKClcbiAge1xuICAgIGNhbml1c2VJZDogJ3NlcnZpY2V3b3JrZXJzJyxcbiAgICBhc3ROb2RlVHlwZTogJ05ld0V4cHJlc3Npb24nLFxuICAgIG9iamVjdDogJ1NlcnZpY2VXb3JrZXInXG4gIH0sXG4gIHtcbiAgICBjYW5pdXNlSWQ6ICdzZXJ2aWNld29ya2VycycsXG4gICAgYXN0Tm9kZVR5cGU6ICdNZW1iZXJFeHByZXNzaW9uJyxcbiAgICBvYmplY3Q6ICduYXZpZ2F0b3InLFxuICAgIHByb3BlcnR5OiAnc2VydmljZVdvcmtlcidcbiAgfSxcbiAgLy8gZG9jdW1lbnQucXVlcnlTZWxlY3RvcigpXG4gIHtcbiAgICBjYW5pdXNlSWQ6ICdxdWVyeXNlbGVjdG9yJyxcbiAgICBhc3ROb2RlVHlwZTogJ01lbWJlckV4cHJlc3Npb24nLFxuICAgIG9iamVjdDogJ2RvY3VtZW50JyxcbiAgICBwcm9wZXJ0eTogJ3F1ZXJ5U2VsZWN0b3InXG4gIH0sXG4gIC8vIEludGVyc2VjdGlvbk9ic2VydmVyXG4gIHtcbiAgICBjYW5pdXNlSWQ6ICdpbnRlcnNlY3Rpb25vYnNlcnZlcicsXG4gICAgYXN0Tm9kZVR5cGU6ICdOZXdFeHByZXNzaW9uJyxcbiAgICBvYmplY3Q6ICdJbnRlcnNlY3Rpb25PYnNlcnZlcidcbiAgfSxcbiAgLy8gUmVzaXplT2JzZXJ2ZXJcbiAge1xuICAgIGNhbml1c2VJZDogJ3Jlc2l6ZW9ic2VydmVyJyxcbiAgICBhc3ROb2RlVHlwZTogJ05ld0V4cHJlc3Npb24nLFxuICAgIG9iamVjdDogJ1Jlc2l6ZU9ic2VydmVyJ1xuICB9LFxuICAvLyBQYXltZW50UmVxdWVzdFxuICB7XG4gICAgY2FuaXVzZUlkOiAncGF5bWVudC1yZXF1ZXN0JyxcbiAgICBhc3ROb2RlVHlwZTogJ05ld0V4cHJlc3Npb24nLFxuICAgIG9iamVjdDogJ1BheW1lbnRSZXF1ZXN0J1xuICB9LFxuICAvLyBQcm9taXNlc1xuICB7XG4gICAgY2FuaXVzZUlkOiAncHJvbWlzZXMnLFxuICAgIGFzdE5vZGVUeXBlOiAnTmV3RXhwcmVzc2lvbicsXG4gICAgb2JqZWN0OiAnUHJvbWlzZSdcbiAgfSxcbiAge1xuICAgIGNhbml1c2VJZDogJ3Byb21pc2VzJyxcbiAgICBhc3ROb2RlVHlwZTogJ01lbWJlckV4cHJlc3Npb24nLFxuICAgIG9iamVjdDogJ1Byb21pc2UnLFxuICAgIHByb3BlcnR5OiAncmVzb2x2ZSdcbiAgfSxcbiAge1xuICAgIGNhbml1c2VJZDogJ3Byb21pc2VzJyxcbiAgICBhc3ROb2RlVHlwZTogJ01lbWJlckV4cHJlc3Npb24nLFxuICAgIG9iamVjdDogJ1Byb21pc2UnLFxuICAgIHByb3BlcnR5OiAnYWxsJ1xuICB9LFxuICB7XG4gICAgY2FuaXVzZUlkOiAncHJvbWlzZXMnLFxuICAgIGFzdE5vZGVUeXBlOiAnTWVtYmVyRXhwcmVzc2lvbicsXG4gICAgb2JqZWN0OiAnUHJvbWlzZScsXG4gICAgcHJvcGVydHk6ICdyYWNlJ1xuICB9LFxuICB7XG4gICAgY2FuaXVzZUlkOiAncHJvbWlzZXMnLFxuICAgIGFzdE5vZGVUeXBlOiAnTWVtYmVyRXhwcmVzc2lvbicsXG4gICAgb2JqZWN0OiAnUHJvbWlzZScsXG4gICAgcHJvcGVydHk6ICdyZWplY3QnXG4gIH0sXG4gIC8vIGZldGNoXG4gIHtcbiAgICBjYW5pdXNlSWQ6ICdmZXRjaCcsXG4gICAgYXN0Tm9kZVR5cGU6ICdDYWxsRXhwcmVzc2lvbicsXG4gICAgb2JqZWN0OiAnZmV0Y2gnXG4gIH0sXG4gIC8vIGRvY3VtZW50LmN1cnJlbnRTY3JpcHQoKVxuICB7XG4gICAgY2FuaXVzZUlkOiAnZG9jdW1lbnQtY3VycmVudHNjcmlwdCcsXG4gICAgYXN0Tm9kZVR5cGU6ICdNZW1iZXJFeHByZXNzaW9uJyxcbiAgICBvYmplY3Q6ICdkb2N1bWVudCcsXG4gICAgcHJvcGVydHk6ICdjdXJyZW50U2NyaXB0J1xuICB9LFxuICAvLyBVUkxcbiAge1xuICAgIGNhbml1c2VJZDogJ3VybCcsXG4gICAgYXN0Tm9kZVR5cGU6ICdOZXdFeHByZXNzaW9uJyxcbiAgICBvYmplY3Q6ICdVUkwnXG4gIH0sXG4gIC8vIFVSTFNlYXJjaFBhcmFtc1xuICB7XG4gICAgY2FuaXVzZUlkOiAndXJsc2VhcmNocGFyYW1zJyxcbiAgICBhc3ROb2RlVHlwZTogJ05ld0V4cHJlc3Npb24nLFxuICAgIG9iamVjdDogJ1VSTFNlYXJjaFBhcmFtcydcbiAgfSxcbiAgLy8gcGVyZm9ybWFuY2Uubm93KClcbiAge1xuICAgIGNhbml1c2VJZDogJ2hpZ2gtcmVzb2x1dGlvbi10aW1lJyxcbiAgICBhc3ROb2RlVHlwZTogJ01lbWJlckV4cHJlc3Npb24nLFxuICAgIG9iamVjdDogJ3BlcmZvcm1hbmNlJyxcbiAgICBwcm9wZXJ0eTogJ25vdydcbiAgfSxcbiAge1xuICAgIGNhbml1c2VJZDogJ3R5cGVkYXJyYXlzJyxcbiAgICBhc3ROb2RlVHlwZTogJ05ld0V4cHJlc3Npb24nLFxuICAgIG9iamVjdDogJ1R5cGVkQXJyYXknXG4gIH0sXG4gIHtcbiAgICBjYW5pdXNlSWQ6ICd0eXBlZGFycmF5cycsXG4gICAgYXN0Tm9kZVR5cGU6ICdOZXdFeHByZXNzaW9uJyxcbiAgICBvYmplY3Q6ICdJbnQ4QXJyYXknXG4gIH0sXG4gIHtcbiAgICBjYW5pdXNlSWQ6ICd0eXBlZGFycmF5cycsXG4gICAgYXN0Tm9kZVR5cGU6ICdOZXdFeHByZXNzaW9uJyxcbiAgICBvYmplY3Q6ICdVaW50OEFycmF5J1xuICB9LFxuICB7XG4gICAgY2FuaXVzZUlkOiAndHlwZWRhcnJheXMnLFxuICAgIGFzdE5vZGVUeXBlOiAnTmV3RXhwcmVzc2lvbicsXG4gICAgb2JqZWN0OiAnVWludDhDbGFtcGVkQXJyYXknXG4gIH0sXG4gIHtcbiAgICBjYW5pdXNlSWQ6ICd0eXBlZGFycmF5cycsXG4gICAgYXN0Tm9kZVR5cGU6ICdOZXdFeHByZXNzaW9uJyxcbiAgICBvYmplY3Q6ICdJbnQxNkFycmF5J1xuICB9LFxuICB7XG4gICAgY2FuaXVzZUlkOiAndHlwZWRhcnJheXMnLFxuICAgIGFzdE5vZGVUeXBlOiAnTmV3RXhwcmVzc2lvbicsXG4gICAgb2JqZWN0OiAnVWludDE2QXJyYXknXG4gIH0sXG4gIHtcbiAgICBjYW5pdXNlSWQ6ICd0eXBlZGFycmF5cycsXG4gICAgYXN0Tm9kZVR5cGU6ICdOZXdFeHByZXNzaW9uJyxcbiAgICBvYmplY3Q6ICdJbnQzMkFycmF5J1xuICB9LFxuICB7XG4gICAgY2FuaXVzZUlkOiAndHlwZWRhcnJheXMnLFxuICAgIGFzdE5vZGVUeXBlOiAnTmV3RXhwcmVzc2lvbicsXG4gICAgb2JqZWN0OiAnVWludDMyQXJyYXknXG4gIH0sXG4gIHtcbiAgICBjYW5pdXNlSWQ6ICd0eXBlZGFycmF5cycsXG4gICAgYXN0Tm9kZVR5cGU6ICdOZXdFeHByZXNzaW9uJyxcbiAgICBvYmplY3Q6ICdGbG9hdDMyQXJyYXknXG4gIH0sXG4gIHtcbiAgICBjYW5pdXNlSWQ6ICd0eXBlZGFycmF5cycsXG4gICAgYXN0Tm9kZVR5cGU6ICdOZXdFeHByZXNzaW9uJyxcbiAgICBvYmplY3Q6ICdGbG9hdDY0QXJyYXknXG4gIH1cbl0ubWFwKHJ1bGUgPT4gKHtcbiAgLi4ucnVsZSxcbiAgZ2V0VW5zdXBwb3J0ZWRUYXJnZXRzLFxuICBpZDogcnVsZS5wcm9wZXJ0eSA/IGAke3J1bGUub2JqZWN0fS4ke3J1bGUucHJvcGVydHl9YCA6IHJ1bGUub2JqZWN0LFxuICBwcm90b0NoYWluSWQ6IHJ1bGUucHJvcGVydHkgPyBgJHtydWxlLm9iamVjdH0uJHtydWxlLnByb3BlcnR5fWAgOiBydWxlLm9iamVjdCxcbiAgcHJvdG9DaGFpbjogcnVsZS5wcm9wZXJ0eSA/IFtydWxlLm9iamVjdCwgcnVsZS5wcm9wZXJ0eV0gOiBbcnVsZS5vYmplY3RdXG59KSk7XG5cbmV4cG9ydCBkZWZhdWx0IENhbklVc2VQcm92aWRlcjtcbiJdfQ==