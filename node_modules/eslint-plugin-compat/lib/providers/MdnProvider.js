"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.isSupportedByMDN = isSupportedByMDN;
exports.getUnsupportedTargets = getUnsupportedTargets;
exports.default = void 0;

var _astMetadataInferer = _interopRequireDefault(require("ast-metadata-inferer"));

var _semver = _interopRequireDefault(require("semver"));

var _Versioning = require("../Versioning");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const mdnRecords = new Map(_astMetadataInferer.default.map(e => [e.protoChainId, e]));
/**
 * Map ids of mdn targets to their "common/friendly" name
 */

const targetIdMappings = {
  chrome: 'chrome',
  firefox: 'firefox',
  opera: 'opera',
  safari: 'safari',
  safari_ios: 'ios_saf',
  ie: 'ie',
  edge_mobile: 'ie_mob',
  edge: 'edge',
  opera_android: 'and_opera',
  chrome_android: 'and_chrome',
  firefox_android: 'and_firefox',
  webview_android: 'and_webview',
  samsunginternet_android: 'and_samsung',
  nodejs: 'node'
};
const reversedTargetMappings = (0, _Versioning.reverseTargetMappings)(targetIdMappings);
/**
 * Take a target's id and return it's full name by using `targetNameMappings`
 * ex. {target: and_ff, version: 40} => 'Android FireFox 40'
 */

function formatTargetNames(target) {
  return `${_Versioning.STANDARD_TARGET_NAME_MAPPING[target.target]} ${target.version}`;
}
/**
 * Convert '9' => '9.0.0'
 */


function customCoerce(version) {
  return version.length === 1 ? [version, 0, 0].join('.') : version;
}
/*
 * Return if MDN supports the API or not
 */


function isSupportedByMDN(node, {
  version,
  target: mdnTarget
}) {
  const target = reversedTargetMappings[mdnTarget]; // If no record could be found, return true. Rules might not
  // be found because they could belong to another provider

  if (!mdnRecords.has(node.protoChainId)) return true;
  const record = mdnRecords.get(node.protoChainId);
  if (!record || !record.compat.support) return true;
  const compatRecord = record.compat.support[target];
  if (!compatRecord) return true;
  if (!Array.isArray(compatRecord) && !('version_added' in compatRecord)) return true;
  const {
    version_added: versionAdded
  } = Array.isArray(compatRecord) ? compatRecord.find(e => 'version_added' in e) : compatRecord; // If a version is true then it is supported but version is unsure

  if (typeof versionAdded === 'boolean') return versionAdded;
  if (versionAdded === null) return true; // Special case for Safari TP: TP is always gte than any other releases

  if (target === 'safari') {
    if (version === 'TP') return true;
    if (versionAdded === 'TP') return false;
  } // A browser supports an API if its version is greater than or equal
  // to the first version of the browser that API was added in


  const semverCurrent = _semver.default.coerce(customCoerce(version));

  const semverAdded = _semver.default.coerce(customCoerce(versionAdded)); // semver.coerce() might be null for non-semvers (other than Safari TP)
  // Just warn and treat features as supported here for now to avoid lint from
  // crashing


  if (!semverCurrent) {
    // eslint-disable-next-line no-console
    console.warn(`eslint-plugin-compat: A non-semver target "${target} ${version}" matched for the feature ${node.protoChainId}, skipping. You're welcome to submit this log to https://github.com/amilajack/eslint-plugin-compat/issues for analysis.`);
    return true;
  }

  if (!versionAdded) {
    // eslint-disable-next-line no-console
    console.warn(`eslint-plugin-compat: The feature ${node.protoChainId} is supported since a non-semver target "${target} ${versionAdded}", skipping. You're welcome to submit this log to https://github.com/amilajack/eslint-plugin-compat/issues for analysis.`);
    return true;
  }

  return _semver.default.gte(semverCurrent, semverAdded);
}
/**
 * Return an array of all unsupported targets
 */


function getUnsupportedTargets(node, targets) {
  return targets.filter(target => !isSupportedByMDN(node, target)).map(formatTargetNames);
}

function getMetadataName(metadata) {
  switch (metadata.protoChain.length) {
    case 1:
      {
        return metadata.protoChain[0];
      }

    default:
      return `${metadata.protoChain.join('.')}()`;
  }
}

const MdnProvider = _astMetadataInferer.default // Create entries for each ast node type
.map(metadata => metadata.astNodeTypes.map(astNodeType => ({ ...metadata,
  name: getMetadataName(metadata),
  id: metadata.protoChainId,
  protoChainId: metadata.protoChainId,
  astNodeType,
  object: metadata.protoChain[0],
  // @TODO Handle cases where 'prototype' is in protoChain
  property: metadata.protoChain[1]
}))) // Flatten the array of arrays
.reduce((p, c) => [...p, ...c]) // Add rule and target support logic for each entry
.map(rule => ({ ...rule,
  getUnsupportedTargets
}));

var _default = MdnProvider;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9wcm92aWRlcnMvTWRuUHJvdmlkZXIuanMiXSwibmFtZXMiOlsibWRuUmVjb3JkcyIsIk1hcCIsIkFzdE1ldGFkYXRhIiwibWFwIiwiZSIsInByb3RvQ2hhaW5JZCIsInRhcmdldElkTWFwcGluZ3MiLCJjaHJvbWUiLCJmaXJlZm94Iiwib3BlcmEiLCJzYWZhcmkiLCJzYWZhcmlfaW9zIiwiaWUiLCJlZGdlX21vYmlsZSIsImVkZ2UiLCJvcGVyYV9hbmRyb2lkIiwiY2hyb21lX2FuZHJvaWQiLCJmaXJlZm94X2FuZHJvaWQiLCJ3ZWJ2aWV3X2FuZHJvaWQiLCJzYW1zdW5naW50ZXJuZXRfYW5kcm9pZCIsIm5vZGVqcyIsInJldmVyc2VkVGFyZ2V0TWFwcGluZ3MiLCJmb3JtYXRUYXJnZXROYW1lcyIsInRhcmdldCIsIlNUQU5EQVJEX1RBUkdFVF9OQU1FX01BUFBJTkciLCJ2ZXJzaW9uIiwiY3VzdG9tQ29lcmNlIiwibGVuZ3RoIiwiam9pbiIsImlzU3VwcG9ydGVkQnlNRE4iLCJub2RlIiwibWRuVGFyZ2V0IiwiaGFzIiwicmVjb3JkIiwiZ2V0IiwiY29tcGF0Iiwic3VwcG9ydCIsImNvbXBhdFJlY29yZCIsIkFycmF5IiwiaXNBcnJheSIsInZlcnNpb25fYWRkZWQiLCJ2ZXJzaW9uQWRkZWQiLCJmaW5kIiwic2VtdmVyQ3VycmVudCIsInNlbXZlciIsImNvZXJjZSIsInNlbXZlckFkZGVkIiwiY29uc29sZSIsIndhcm4iLCJndGUiLCJnZXRVbnN1cHBvcnRlZFRhcmdldHMiLCJ0YXJnZXRzIiwiZmlsdGVyIiwiZ2V0TWV0YWRhdGFOYW1lIiwibWV0YWRhdGEiLCJwcm90b0NoYWluIiwiTWRuUHJvdmlkZXIiLCJhc3ROb2RlVHlwZXMiLCJhc3ROb2RlVHlwZSIsIm5hbWUiLCJpZCIsIm9iamVjdCIsInByb3BlcnR5IiwicmVkdWNlIiwicCIsImMiLCJydWxlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7OztBQXdCQSxNQUFNQSxVQUE4QyxHQUFHLElBQUlDLEdBQUosQ0FDckRDLDRCQUFZQyxHQUFaLENBQWdCQyxDQUFDLElBQUksQ0FBQ0EsQ0FBQyxDQUFDQyxZQUFILEVBQWlCRCxDQUFqQixDQUFyQixDQURxRCxDQUF2RDtBQUlBOzs7O0FBR0EsTUFBTUUsZ0JBQWdCLEdBQUc7QUFDdkJDLEVBQUFBLE1BQU0sRUFBRSxRQURlO0FBRXZCQyxFQUFBQSxPQUFPLEVBQUUsU0FGYztBQUd2QkMsRUFBQUEsS0FBSyxFQUFFLE9BSGdCO0FBSXZCQyxFQUFBQSxNQUFNLEVBQUUsUUFKZTtBQUt2QkMsRUFBQUEsVUFBVSxFQUFFLFNBTFc7QUFNdkJDLEVBQUFBLEVBQUUsRUFBRSxJQU5tQjtBQU92QkMsRUFBQUEsV0FBVyxFQUFFLFFBUFU7QUFRdkJDLEVBQUFBLElBQUksRUFBRSxNQVJpQjtBQVN2QkMsRUFBQUEsYUFBYSxFQUFFLFdBVFE7QUFVdkJDLEVBQUFBLGNBQWMsRUFBRSxZQVZPO0FBV3ZCQyxFQUFBQSxlQUFlLEVBQUUsYUFYTTtBQVl2QkMsRUFBQUEsZUFBZSxFQUFFLGFBWk07QUFhdkJDLEVBQUFBLHVCQUF1QixFQUFFLGFBYkY7QUFjdkJDLEVBQUFBLE1BQU0sRUFBRTtBQWRlLENBQXpCO0FBaUJBLE1BQU1DLHNCQUFzQixHQUFHLHVDQUFzQmYsZ0JBQXRCLENBQS9CO0FBRUE7Ozs7O0FBSUEsU0FBU2dCLGlCQUFULENBQTJCQyxNQUEzQixFQUFtRDtBQUNqRCxTQUFRLEdBQUVDLHlDQUE2QkQsTUFBTSxDQUFDQSxNQUFwQyxDQUE0QyxJQUFHQSxNQUFNLENBQUNFLE9BQVEsRUFBeEU7QUFDRDtBQUVEOzs7OztBQUdBLFNBQVNDLFlBQVQsQ0FBc0JELE9BQXRCLEVBQStDO0FBQzdDLFNBQU9BLE9BQU8sQ0FBQ0UsTUFBUixLQUFtQixDQUFuQixHQUF1QixDQUFDRixPQUFELEVBQVUsQ0FBVixFQUFhLENBQWIsRUFBZ0JHLElBQWhCLENBQXFCLEdBQXJCLENBQXZCLEdBQW1ESCxPQUExRDtBQUNEO0FBRUQ7Ozs7O0FBR08sU0FBU0ksZ0JBQVQsQ0FDTEMsSUFESyxFQUVMO0FBQUVMLEVBQUFBLE9BQUY7QUFBV0YsRUFBQUEsTUFBTSxFQUFFUTtBQUFuQixDQUZLLEVBR0k7QUFDVCxRQUFNUixNQUFNLEdBQUdGLHNCQUFzQixDQUFDVSxTQUFELENBQXJDLENBRFMsQ0FFVDtBQUNBOztBQUNBLE1BQUksQ0FBQy9CLFVBQVUsQ0FBQ2dDLEdBQVgsQ0FBZUYsSUFBSSxDQUFDekIsWUFBcEIsQ0FBTCxFQUF3QyxPQUFPLElBQVA7QUFDeEMsUUFBTTRCLE1BQU0sR0FBR2pDLFVBQVUsQ0FBQ2tDLEdBQVgsQ0FBZUosSUFBSSxDQUFDekIsWUFBcEIsQ0FBZjtBQUNBLE1BQUksQ0FBQzRCLE1BQUQsSUFBVyxDQUFDQSxNQUFNLENBQUNFLE1BQVAsQ0FBY0MsT0FBOUIsRUFBdUMsT0FBTyxJQUFQO0FBQ3ZDLFFBQU1DLFlBQVksR0FBR0osTUFBTSxDQUFDRSxNQUFQLENBQWNDLE9BQWQsQ0FBc0JiLE1BQXRCLENBQXJCO0FBQ0EsTUFBSSxDQUFDYyxZQUFMLEVBQW1CLE9BQU8sSUFBUDtBQUNuQixNQUFJLENBQUNDLEtBQUssQ0FBQ0MsT0FBTixDQUFjRixZQUFkLENBQUQsSUFBZ0MsRUFBRSxtQkFBbUJBLFlBQXJCLENBQXBDLEVBQ0UsT0FBTyxJQUFQO0FBQ0YsUUFBTTtBQUFFRyxJQUFBQSxhQUFhLEVBQUVDO0FBQWpCLE1BQWtDSCxLQUFLLENBQUNDLE9BQU4sQ0FBY0YsWUFBZCxJQUNwQ0EsWUFBWSxDQUFDSyxJQUFiLENBQWtCdEMsQ0FBQyxJQUFJLG1CQUFtQkEsQ0FBMUMsQ0FEb0MsR0FFcENpQyxZQUZKLENBWFMsQ0FlVDs7QUFDQSxNQUFJLE9BQU9JLFlBQVAsS0FBd0IsU0FBNUIsRUFBdUMsT0FBT0EsWUFBUDtBQUN2QyxNQUFJQSxZQUFZLEtBQUssSUFBckIsRUFBMkIsT0FBTyxJQUFQLENBakJsQixDQW1CVDs7QUFDQSxNQUFJbEIsTUFBTSxLQUFLLFFBQWYsRUFBeUI7QUFDdkIsUUFBSUUsT0FBTyxLQUFLLElBQWhCLEVBQXNCLE9BQU8sSUFBUDtBQUN0QixRQUFJZ0IsWUFBWSxLQUFLLElBQXJCLEVBQTJCLE9BQU8sS0FBUDtBQUM1QixHQXZCUSxDQXdCVDtBQUNBOzs7QUFDQSxRQUFNRSxhQUFhLEdBQUdDLGdCQUFPQyxNQUFQLENBQWNuQixZQUFZLENBQUNELE9BQUQsQ0FBMUIsQ0FBdEI7O0FBQ0EsUUFBTXFCLFdBQVcsR0FBR0YsZ0JBQU9DLE1BQVAsQ0FBY25CLFlBQVksQ0FBQ2UsWUFBRCxDQUExQixDQUFwQixDQTNCUyxDQTZCVDtBQUNBO0FBQ0E7OztBQUNBLE1BQUksQ0FBQ0UsYUFBTCxFQUFvQjtBQUNsQjtBQUNBSSxJQUFBQSxPQUFPLENBQUNDLElBQVIsQ0FDRyw4Q0FBNkN6QixNQUFPLElBQUdFLE9BQVEsNkJBQTRCSyxJQUFJLENBQUN6QixZQUFhLHlIQURoSDtBQUdBLFdBQU8sSUFBUDtBQUNEOztBQUNELE1BQUksQ0FBQ29DLFlBQUwsRUFBbUI7QUFDakI7QUFDQU0sSUFBQUEsT0FBTyxDQUFDQyxJQUFSLENBQ0cscUNBQW9DbEIsSUFBSSxDQUFDekIsWUFBYSw0Q0FBMkNrQixNQUFPLElBQUdrQixZQUFhLDBIQUQzSDtBQUdBLFdBQU8sSUFBUDtBQUNEOztBQUNELFNBQU9HLGdCQUFPSyxHQUFQLENBQVdOLGFBQVgsRUFBMEJHLFdBQTFCLENBQVA7QUFDRDtBQUVEOzs7OztBQUdPLFNBQVNJLHFCQUFULENBQ0xwQixJQURLLEVBRUxxQixPQUZLLEVBR1U7QUFDZixTQUFPQSxPQUFPLENBQ1hDLE1BREksQ0FDRzdCLE1BQU0sSUFBSSxDQUFDTSxnQkFBZ0IsQ0FBQ0MsSUFBRCxFQUFPUCxNQUFQLENBRDlCLEVBRUpwQixHQUZJLENBRUFtQixpQkFGQSxDQUFQO0FBR0Q7O0FBRUQsU0FBUytCLGVBQVQsQ0FBeUJDLFFBQXpCLEVBQXlDO0FBQ3ZDLFVBQVFBLFFBQVEsQ0FBQ0MsVUFBVCxDQUFvQjVCLE1BQTVCO0FBQ0UsU0FBSyxDQUFMO0FBQVE7QUFDTixlQUFPMkIsUUFBUSxDQUFDQyxVQUFULENBQW9CLENBQXBCLENBQVA7QUFDRDs7QUFDRDtBQUNFLGFBQVEsR0FBRUQsUUFBUSxDQUFDQyxVQUFULENBQW9CM0IsSUFBcEIsQ0FBeUIsR0FBekIsQ0FBOEIsSUFBeEM7QUFMSjtBQU9EOztBQUVELE1BQU00QixXQUF3QixHQUFHdEQsNEJBQy9CO0FBRCtCLENBRTlCQyxHQUY4QixDQUUxQm1ELFFBQVEsSUFDWEEsUUFBUSxDQUFDRyxZQUFULENBQXNCdEQsR0FBdEIsQ0FBMEJ1RCxXQUFXLEtBQUssRUFDeEMsR0FBR0osUUFEcUM7QUFFeENLLEVBQUFBLElBQUksRUFBRU4sZUFBZSxDQUFDQyxRQUFELENBRm1CO0FBR3hDTSxFQUFBQSxFQUFFLEVBQUVOLFFBQVEsQ0FBQ2pELFlBSDJCO0FBSXhDQSxFQUFBQSxZQUFZLEVBQUVpRCxRQUFRLENBQUNqRCxZQUppQjtBQUt4Q3FELEVBQUFBLFdBTHdDO0FBTXhDRyxFQUFBQSxNQUFNLEVBQUVQLFFBQVEsQ0FBQ0MsVUFBVCxDQUFvQixDQUFwQixDQU5nQztBQU94QztBQUNBTyxFQUFBQSxRQUFRLEVBQUVSLFFBQVEsQ0FBQ0MsVUFBVCxDQUFvQixDQUFwQjtBQVI4QixDQUFMLENBQXJDLENBSDZCLEVBYy9CO0FBZCtCLENBZTlCUSxNQWY4QixDQWV2QixDQUFDQyxDQUFELEVBQUlDLENBQUosS0FBVSxDQUFDLEdBQUdELENBQUosRUFBTyxHQUFHQyxDQUFWLENBZmEsRUFnQi9CO0FBaEIrQixDQWlCOUI5RCxHQWpCOEIsQ0FpQjFCK0QsSUFBSSxLQUFLLEVBQ1osR0FBR0EsSUFEUztBQUVaaEIsRUFBQUE7QUFGWSxDQUFMLENBakJzQixDQUFqQzs7ZUFzQmVNLFciLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgQXN0TWV0YWRhdGEgZnJvbSAnYXN0LW1ldGFkYXRhLWluZmVyZXInO1xuaW1wb3J0IHNlbXZlciBmcm9tICdzZW12ZXInO1xuaW1wb3J0IHtcbiAgU1RBTkRBUkRfVEFSR0VUX05BTUVfTUFQUElORyxcbiAgcmV2ZXJzZVRhcmdldE1hcHBpbmdzXG59IGZyb20gJy4uL1ZlcnNpb25pbmcnO1xuaW1wb3J0IHR5cGUgeyBOb2RlLCBUYXJnZXRzLCBUYXJnZXQgfSBmcm9tICcuLi9MaW50VHlwZXMnO1xuXG50eXBlIEFzdE1ldGFkYXRhUmVjb3JkVHlwZSA9IHtcbiAgYXBpVHlwZTogJ2pzLWFwaScgfCAnY3NzLWFwaScsXG4gIHR5cGU6ICdqcy1hcGknIHwgJ2Nzcy1hcGknLFxuICBwcm90b0NoYWluOiBBcnJheTxzdHJpbmc+LFxuICBwcm90b0NoYWluSWQ6IHN0cmluZyxcbiAgYXN0Tm9kZVR5cGVzOiBBcnJheTxzdHJpbmc+LFxuICBpc1N0YXRpYzogYm9vbGVhbixcbiAgY29tcGF0OiB7XG4gICAgc3VwcG9ydDoge1xuICAgICAgW2Jyb3dzZXJOYW1lOiBzdHJpbmddOiB7XG4gICAgICAgIC8vIElmIGEgdmVyc2lvbiBpcyB0cnVlIHRoZW4gaXQgaXMgc3VwcG9ydGVkIGJ1dCB2ZXJzaW9uIGlzIHVuc3VyZVxuICAgICAgICB2ZXJzaW9uX2FkZGVkOiBzdHJpbmcgfCBib29sZWFuXG4gICAgICB9XG4gICAgfSxcbiAgICBbeDogc3RyaW5nXTogYW55XG4gIH1cbn07XG5cbmNvbnN0IG1kblJlY29yZHM6IE1hcDxzdHJpbmcsIEFzdE1ldGFkYXRhUmVjb3JkVHlwZT4gPSBuZXcgTWFwKFxuICBBc3RNZXRhZGF0YS5tYXAoZSA9PiBbZS5wcm90b0NoYWluSWQsIGVdKVxuKTtcblxuLyoqXG4gKiBNYXAgaWRzIG9mIG1kbiB0YXJnZXRzIHRvIHRoZWlyIFwiY29tbW9uL2ZyaWVuZGx5XCIgbmFtZVxuICovXG5jb25zdCB0YXJnZXRJZE1hcHBpbmdzID0ge1xuICBjaHJvbWU6ICdjaHJvbWUnLFxuICBmaXJlZm94OiAnZmlyZWZveCcsXG4gIG9wZXJhOiAnb3BlcmEnLFxuICBzYWZhcmk6ICdzYWZhcmknLFxuICBzYWZhcmlfaW9zOiAnaW9zX3NhZicsXG4gIGllOiAnaWUnLFxuICBlZGdlX21vYmlsZTogJ2llX21vYicsXG4gIGVkZ2U6ICdlZGdlJyxcbiAgb3BlcmFfYW5kcm9pZDogJ2FuZF9vcGVyYScsXG4gIGNocm9tZV9hbmRyb2lkOiAnYW5kX2Nocm9tZScsXG4gIGZpcmVmb3hfYW5kcm9pZDogJ2FuZF9maXJlZm94JyxcbiAgd2Vidmlld19hbmRyb2lkOiAnYW5kX3dlYnZpZXcnLFxuICBzYW1zdW5naW50ZXJuZXRfYW5kcm9pZDogJ2FuZF9zYW1zdW5nJyxcbiAgbm9kZWpzOiAnbm9kZSdcbn07XG5cbmNvbnN0IHJldmVyc2VkVGFyZ2V0TWFwcGluZ3MgPSByZXZlcnNlVGFyZ2V0TWFwcGluZ3ModGFyZ2V0SWRNYXBwaW5ncyk7XG5cbi8qKlxuICogVGFrZSBhIHRhcmdldCdzIGlkIGFuZCByZXR1cm4gaXQncyBmdWxsIG5hbWUgYnkgdXNpbmcgYHRhcmdldE5hbWVNYXBwaW5nc2BcbiAqIGV4LiB7dGFyZ2V0OiBhbmRfZmYsIHZlcnNpb246IDQwfSA9PiAnQW5kcm9pZCBGaXJlRm94IDQwJ1xuICovXG5mdW5jdGlvbiBmb3JtYXRUYXJnZXROYW1lcyh0YXJnZXQ6IFRhcmdldCk6IHN0cmluZyB7XG4gIHJldHVybiBgJHtTVEFOREFSRF9UQVJHRVRfTkFNRV9NQVBQSU5HW3RhcmdldC50YXJnZXRdfSAke3RhcmdldC52ZXJzaW9ufWA7XG59XG5cbi8qKlxuICogQ29udmVydCAnOScgPT4gJzkuMC4wJ1xuICovXG5mdW5jdGlvbiBjdXN0b21Db2VyY2UodmVyc2lvbjogc3RyaW5nKTogc3RyaW5nIHtcbiAgcmV0dXJuIHZlcnNpb24ubGVuZ3RoID09PSAxID8gW3ZlcnNpb24sIDAsIDBdLmpvaW4oJy4nKSA6IHZlcnNpb247XG59XG5cbi8qXG4gKiBSZXR1cm4gaWYgTUROIHN1cHBvcnRzIHRoZSBBUEkgb3Igbm90XG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBpc1N1cHBvcnRlZEJ5TUROKFxuICBub2RlOiBOb2RlLFxuICB7IHZlcnNpb24sIHRhcmdldDogbWRuVGFyZ2V0IH06IFRhcmdldFxuKTogYm9vbGVhbiB7XG4gIGNvbnN0IHRhcmdldCA9IHJldmVyc2VkVGFyZ2V0TWFwcGluZ3NbbWRuVGFyZ2V0XTtcbiAgLy8gSWYgbm8gcmVjb3JkIGNvdWxkIGJlIGZvdW5kLCByZXR1cm4gdHJ1ZS4gUnVsZXMgbWlnaHQgbm90XG4gIC8vIGJlIGZvdW5kIGJlY2F1c2UgdGhleSBjb3VsZCBiZWxvbmcgdG8gYW5vdGhlciBwcm92aWRlclxuICBpZiAoIW1kblJlY29yZHMuaGFzKG5vZGUucHJvdG9DaGFpbklkKSkgcmV0dXJuIHRydWU7XG4gIGNvbnN0IHJlY29yZCA9IG1kblJlY29yZHMuZ2V0KG5vZGUucHJvdG9DaGFpbklkKTtcbiAgaWYgKCFyZWNvcmQgfHwgIXJlY29yZC5jb21wYXQuc3VwcG9ydCkgcmV0dXJuIHRydWU7XG4gIGNvbnN0IGNvbXBhdFJlY29yZCA9IHJlY29yZC5jb21wYXQuc3VwcG9ydFt0YXJnZXRdO1xuICBpZiAoIWNvbXBhdFJlY29yZCkgcmV0dXJuIHRydWU7XG4gIGlmICghQXJyYXkuaXNBcnJheShjb21wYXRSZWNvcmQpICYmICEoJ3ZlcnNpb25fYWRkZWQnIGluIGNvbXBhdFJlY29yZCkpXG4gICAgcmV0dXJuIHRydWU7XG4gIGNvbnN0IHsgdmVyc2lvbl9hZGRlZDogdmVyc2lvbkFkZGVkIH0gPSBBcnJheS5pc0FycmF5KGNvbXBhdFJlY29yZClcbiAgICA/IGNvbXBhdFJlY29yZC5maW5kKGUgPT4gJ3ZlcnNpb25fYWRkZWQnIGluIGUpXG4gICAgOiBjb21wYXRSZWNvcmQ7XG5cbiAgLy8gSWYgYSB2ZXJzaW9uIGlzIHRydWUgdGhlbiBpdCBpcyBzdXBwb3J0ZWQgYnV0IHZlcnNpb24gaXMgdW5zdXJlXG4gIGlmICh0eXBlb2YgdmVyc2lvbkFkZGVkID09PSAnYm9vbGVhbicpIHJldHVybiB2ZXJzaW9uQWRkZWQ7XG4gIGlmICh2ZXJzaW9uQWRkZWQgPT09IG51bGwpIHJldHVybiB0cnVlO1xuXG4gIC8vIFNwZWNpYWwgY2FzZSBmb3IgU2FmYXJpIFRQOiBUUCBpcyBhbHdheXMgZ3RlIHRoYW4gYW55IG90aGVyIHJlbGVhc2VzXG4gIGlmICh0YXJnZXQgPT09ICdzYWZhcmknKSB7XG4gICAgaWYgKHZlcnNpb24gPT09ICdUUCcpIHJldHVybiB0cnVlO1xuICAgIGlmICh2ZXJzaW9uQWRkZWQgPT09ICdUUCcpIHJldHVybiBmYWxzZTtcbiAgfVxuICAvLyBBIGJyb3dzZXIgc3VwcG9ydHMgYW4gQVBJIGlmIGl0cyB2ZXJzaW9uIGlzIGdyZWF0ZXIgdGhhbiBvciBlcXVhbFxuICAvLyB0byB0aGUgZmlyc3QgdmVyc2lvbiBvZiB0aGUgYnJvd3NlciB0aGF0IEFQSSB3YXMgYWRkZWQgaW5cbiAgY29uc3Qgc2VtdmVyQ3VycmVudCA9IHNlbXZlci5jb2VyY2UoY3VzdG9tQ29lcmNlKHZlcnNpb24pKTtcbiAgY29uc3Qgc2VtdmVyQWRkZWQgPSBzZW12ZXIuY29lcmNlKGN1c3RvbUNvZXJjZSh2ZXJzaW9uQWRkZWQpKTtcblxuICAvLyBzZW12ZXIuY29lcmNlKCkgbWlnaHQgYmUgbnVsbCBmb3Igbm9uLXNlbXZlcnMgKG90aGVyIHRoYW4gU2FmYXJpIFRQKVxuICAvLyBKdXN0IHdhcm4gYW5kIHRyZWF0IGZlYXR1cmVzIGFzIHN1cHBvcnRlZCBoZXJlIGZvciBub3cgdG8gYXZvaWQgbGludCBmcm9tXG4gIC8vIGNyYXNoaW5nXG4gIGlmICghc2VtdmVyQ3VycmVudCkge1xuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1jb25zb2xlXG4gICAgY29uc29sZS53YXJuKFxuICAgICAgYGVzbGludC1wbHVnaW4tY29tcGF0OiBBIG5vbi1zZW12ZXIgdGFyZ2V0IFwiJHt0YXJnZXR9ICR7dmVyc2lvbn1cIiBtYXRjaGVkIGZvciB0aGUgZmVhdHVyZSAke25vZGUucHJvdG9DaGFpbklkfSwgc2tpcHBpbmcuIFlvdSdyZSB3ZWxjb21lIHRvIHN1Ym1pdCB0aGlzIGxvZyB0byBodHRwczovL2dpdGh1Yi5jb20vYW1pbGFqYWNrL2VzbGludC1wbHVnaW4tY29tcGF0L2lzc3VlcyBmb3IgYW5hbHlzaXMuYFxuICAgICk7XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cbiAgaWYgKCF2ZXJzaW9uQWRkZWQpIHtcbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tY29uc29sZVxuICAgIGNvbnNvbGUud2FybihcbiAgICAgIGBlc2xpbnQtcGx1Z2luLWNvbXBhdDogVGhlIGZlYXR1cmUgJHtub2RlLnByb3RvQ2hhaW5JZH0gaXMgc3VwcG9ydGVkIHNpbmNlIGEgbm9uLXNlbXZlciB0YXJnZXQgXCIke3RhcmdldH0gJHt2ZXJzaW9uQWRkZWR9XCIsIHNraXBwaW5nLiBZb3UncmUgd2VsY29tZSB0byBzdWJtaXQgdGhpcyBsb2cgdG8gaHR0cHM6Ly9naXRodWIuY29tL2FtaWxhamFjay9lc2xpbnQtcGx1Z2luLWNvbXBhdC9pc3N1ZXMgZm9yIGFuYWx5c2lzLmBcbiAgICApO1xuICAgIHJldHVybiB0cnVlO1xuICB9XG4gIHJldHVybiBzZW12ZXIuZ3RlKHNlbXZlckN1cnJlbnQsIHNlbXZlckFkZGVkKTtcbn1cblxuLyoqXG4gKiBSZXR1cm4gYW4gYXJyYXkgb2YgYWxsIHVuc3VwcG9ydGVkIHRhcmdldHNcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGdldFVuc3VwcG9ydGVkVGFyZ2V0cyhcbiAgbm9kZTogTm9kZSxcbiAgdGFyZ2V0czogVGFyZ2V0c1xuKTogQXJyYXk8c3RyaW5nPiB7XG4gIHJldHVybiB0YXJnZXRzXG4gICAgLmZpbHRlcih0YXJnZXQgPT4gIWlzU3VwcG9ydGVkQnlNRE4obm9kZSwgdGFyZ2V0KSlcbiAgICAubWFwKGZvcm1hdFRhcmdldE5hbWVzKTtcbn1cblxuZnVuY3Rpb24gZ2V0TWV0YWRhdGFOYW1lKG1ldGFkYXRhOiBOb2RlKSB7XG4gIHN3aXRjaCAobWV0YWRhdGEucHJvdG9DaGFpbi5sZW5ndGgpIHtcbiAgICBjYXNlIDE6IHtcbiAgICAgIHJldHVybiBtZXRhZGF0YS5wcm90b0NoYWluWzBdO1xuICAgIH1cbiAgICBkZWZhdWx0OlxuICAgICAgcmV0dXJuIGAke21ldGFkYXRhLnByb3RvQ2hhaW4uam9pbignLicpfSgpYDtcbiAgfVxufVxuXG5jb25zdCBNZG5Qcm92aWRlcjogQXJyYXk8Tm9kZT4gPSBBc3RNZXRhZGF0YVxuICAvLyBDcmVhdGUgZW50cmllcyBmb3IgZWFjaCBhc3Qgbm9kZSB0eXBlXG4gIC5tYXAobWV0YWRhdGEgPT5cbiAgICBtZXRhZGF0YS5hc3ROb2RlVHlwZXMubWFwKGFzdE5vZGVUeXBlID0+ICh7XG4gICAgICAuLi5tZXRhZGF0YSxcbiAgICAgIG5hbWU6IGdldE1ldGFkYXRhTmFtZShtZXRhZGF0YSksXG4gICAgICBpZDogbWV0YWRhdGEucHJvdG9DaGFpbklkLFxuICAgICAgcHJvdG9DaGFpbklkOiBtZXRhZGF0YS5wcm90b0NoYWluSWQsXG4gICAgICBhc3ROb2RlVHlwZSxcbiAgICAgIG9iamVjdDogbWV0YWRhdGEucHJvdG9DaGFpblswXSxcbiAgICAgIC8vIEBUT0RPIEhhbmRsZSBjYXNlcyB3aGVyZSAncHJvdG90eXBlJyBpcyBpbiBwcm90b0NoYWluXG4gICAgICBwcm9wZXJ0eTogbWV0YWRhdGEucHJvdG9DaGFpblsxXVxuICAgIH0pKVxuICApXG4gIC8vIEZsYXR0ZW4gdGhlIGFycmF5IG9mIGFycmF5c1xuICAucmVkdWNlKChwLCBjKSA9PiBbLi4ucCwgLi4uY10pXG4gIC8vIEFkZCBydWxlIGFuZCB0YXJnZXQgc3VwcG9ydCBsb2dpYyBmb3IgZWFjaCBlbnRyeVxuICAubWFwKHJ1bGUgPT4gKHtcbiAgICAuLi5ydWxlLFxuICAgIGdldFVuc3VwcG9ydGVkVGFyZ2V0c1xuICB9KSk7XG5cbmV4cG9ydCBkZWZhdWx0IE1kblByb3ZpZGVyO1xuIl19